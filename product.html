<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product • Coffee Taste Box</title>
  <meta name="description" content="Product details and WhatsApp ordering for Coffee Taste Box (Azerbaijan)." />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true">☕</div>
        <div>
          <div class="brand-name">Coffee Taste Box</div>
          <div class="brand-tag">Product</div>
        </div>
      </div>
      <div class="header-actions">
        <a class="btn small" href="shop.html">Shop</a>
        <a class="btn small" href="start.html">Start</a>
        <button class="btn small" data-reset>Reset</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="card" id="productCard">
      <div class="card-head">
        <h1 id="pName">Product</h1>
        <span class="badge" id="pBadge">—</span>
      </div>

      <p class="muted" id="pOneLine">—</p>

      <div class="notice subtle" style="margin-top:14px;">
        <strong>Best for:</strong> <span id="pBestFor">—</span><br/>
        <strong>What you’ll learn:</strong> <span id="pLearn">—</span>
      </div>

      <div class="divider"></div>

      <h3 class="h4">What’s inside</h3>
      <ul class="bullets" id="pInside"></ul>

      <div class="divider"></div>

      <h3 class="h4">How it works (simple)</h3>
      <ol class="bullets" id="pHow"></ol>

      <div class="divider"></div>

      <h3 class="h4">Brew methods supported</h3>
      <div class="chips" id="pMethods"></div>
      <p class="muted small" style="margin-top:10px;" id="pTip"></p>

      <div class="divider"></div>

      <h3 class="h4">Delivery & payment</h3>
      <div id="pDelivery"></div>

      <div class="divider"></div>

      <!-- CLEAN ORDER FLOW -->
      <h3 class="h4">How to order</h3>
      <div class="notice subtle" style="margin-top:12px;">
        <strong>Step 1:</strong> Fill details (optional) → <strong>Step 2:</strong> WhatsApp message opens → <strong>Step 3:</strong>
        we confirm stock + delivery → <strong>payment link after confirmation</strong> → delivery.
      </div>

      <p class="muted small" id="pOrderNote" style="margin-top:10px;">
        You can order even if you haven’t tasted everything yet. We’ll confirm availability and delivery before payment.
      </p>

      <!-- Optional prefill form (doesn't break anything if ignored) -->
      <div class="grid two" style="margin-top:12px;">
        <div class="card subtle">
          <label class="label" for="oQty">Quantity (optional)</label>
          <input class="input" id="oQty" type="number" min="1" step="1" placeholder="1" />

          <div class="divider"></div>

          <label class="label" for="oCity">Delivery city (optional)</label>
          <input class="input" id="oCity" placeholder="Baku" />

          <div class="divider"></div>

          <label class="label" for="oPhone">Phone number (optional)</label>
          <input class="input" id="oPhone" placeholder="+994..." />
          <p class="muted small" style="margin-top:10px;">
            Tip: If you don’t fill these, you can type them in WhatsApp after it opens.
          </p>
        </div>

        <div class="card subtle">
          <div id="oMethodWrap" style="display:none;">
            <label class="label" for="oMethod">Brew method (optional)</label>
            <select class="input" id="oMethod"></select>
            <p class="muted small" style="margin-top:10px;">
              Pick a method you’ll use for the whole box (best for fair comparisons).
            </p>
            <div class="divider"></div>
          </div>

          <div id="oExtraWrap" style="display:none;">
            <label class="label" for="oExtra">Extra note (optional)</label>
            <textarea class="textarea" id="oExtra" rows="4" placeholder="Any notes (color, pack size, capacity, etc.)"></textarea>
          </div>

          <div class="divider"></div>

          <div class="stage-actions inline">
            <a class="btn" href="shop.html">Back to shop</a>
            <a class="btn primary" id="pWhatsApp" target="_blank" href="#">Order on WhatsApp</a>
          </div>

          <p class="muted small" style="margin-top:12px;">
            Note: Some items may rotate based on stock. We’ll confirm before payment.
          </p>
        </div>
      </div>

      <!-- If product not found -->
      <div class="notice" id="notFoundNotice" style="display:none; margin-top:16px;">
        <strong>Product not found:</strong> This product ID doesn’t exist. Please go back to the shop and choose an item again.
        <div class="stage-actions" style="margin-top:12px;">
          <a class="btn primary" href="shop.html">Go to shop</a>
        </div>
      </div>
    </div>

    <script src="catalog.js"></script>
    <script src="app.js"></script>
    <script>
      CTB.initCommon();

      const qs = (s) => document.querySelector(s);

      function getParam(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      function escapeHtml(str){
        return String(str || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      const id = getParam("id") || "beginner_box";
      const P = (window.CTB_PRODUCTS || {})[id];

      const phone = "994XXXXXXXXX"; // CHANGE THIS

      function buildWhatsAppUrl(){
        if(!P) return "#";

        const qty = (qs("#oQty") && qs("#oQty").value) ? qs("#oQty").value.trim() : "";
        const city = (qs("#oCity") && qs("#oCity").value) ? qs("#oCity").value.trim() : "";
        const userPhone = (qs("#oPhone") && qs("#oPhone").value) ? qs("#oPhone").value.trim() : "";
        const method = (qs("#oMethodWrap") && qs("#oMethodWrap").style.display !== "none" && qs("#oMethod"))
          ? (qs("#oMethod").value || "")
          : "";
        const extra = (qs("#oExtra") && qs("#oExtra").value) ? qs("#oExtra").value.trim() : "";

        // Fields from catalog.js (if present)
        const fieldLines = (P.whatsappFields || ["Delivery city", "Phone number"])
          .map(f => `• ${f}:`)
          .join("\n");

        // Helpful prefilled lines
        const prefilled = [];
        if(qty) prefilled.push(`• Quantity: ${qty}`);
        if(method) prefilled.push(`• Brew method: ${method}`);
        if(city) prefilled.push(`• Delivery city: ${city}`);
        if(userPhone) prefilled.push(`• Phone number: ${userPhone}`);
        if(extra) prefilled.push(`• Note: ${extra}`);

        const message =
`Hi! I want to order:

• Product: ${P.whatsappProductLine || P.name}
${prefilled.length ? ("\n" + prefilled.join("\n")) : ""}

If anything is missing:
${fieldLines}

Thank you!`;

        return `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      }

      function wireWhatsAppButton(){
        const btn = qs("#pWhatsApp");
        if(!btn) return;

        const refresh = () => { btn.href = buildWhatsAppUrl(); };

        // initial
        refresh();

        // live updates
        ["#oQty","#oCity","#oPhone","#oMethod","#oExtra"].forEach(sel => {
          const el = qs(sel);
          if(el) el.addEventListener("input", refresh);
          if(el) el.addEventListener("change", refresh);
        });
      }

      if(!P){
        // hide main content bits
        qs("#pName").textContent = "Product not found";
        qs("#pOneLine").textContent = "This product ID does not exist. Please go back to the shop.";
        qs("#pBadge").textContent = "—";
        qs("#pBestFor").textContent = "—";
        qs("#pLearn").textContent = "—";

        qs("#pInside").innerHTML = "";
        qs("#pHow").innerHTML = "";
        qs("#pMethods").innerHTML = "";
        qs("#pTip").textContent = "";
        qs("#pDelivery").innerHTML = "";

        // hide order UI
        if(qs("#pWhatsApp")) qs("#pWhatsApp").style.display = "none";
        if(qs("#notFoundNotice")) qs("#notFoundNotice").style.display = "block";
      } else {
        document.title = `${P.name} • Coffee Taste Box`;

        qs("#pName").textContent = P.name;
        qs("#pBadge").textContent = P.badge || "—";
        qs("#pOneLine").textContent = P.oneLine || "—";
        qs("#pBestFor").textContent = P.bestFor || "—";
        qs("#pLearn").textContent = P.learn || "—";

        // inside list
        qs("#pInside").innerHTML = (P.inside || [])
          .map(([k,v]) => `<li><strong>${escapeHtml(k)}:</strong> ${escapeHtml(v)}</li>`)
          .join("");

        // how it works list
        qs("#pHow").innerHTML = (P.howItWorks || [])
          .map(x => `<li>${escapeHtml(x)}</li>`)
          .join("");

        // methods chips + dropdown (Option A UX)
        const methods = (P.methods || []);
        const methodsWrap = qs("#pMethods");
        if(methodsWrap){
          methodsWrap.innerHTML = methods.length
            ? methods.map(m => `<span class="chip-btn is-active" style="pointer-events:none;">${escapeHtml(m)}</span>`).join("")
            : `<span class="muted small">—</span>`;
        }

        // method dropdown only if meaningful
        const oMethodWrap = qs("#oMethodWrap");
        const oMethod = qs("#oMethod");
        if(oMethodWrap && oMethod){
          if(methods && methods.length && methods[0] !== "Any"){
            oMethodWrap.style.display = "block";
            oMethod.innerHTML = `
              <option value="">Not sure</option>
              ${methods.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("")}
            `;
          } else {
            oMethodWrap.style.display = "none";
          }
        }

        // extra note field: show for accessories/equipment/bundles as a nice catch-all
        const extraWrap = qs("#oExtraWrap");
        if(extraWrap){
          extraWrap.style.display = "block";
        }

        // tip
        qs("#pTip").textContent = P.tip || "";

        // delivery (ensure copy consistency)
        // If catalog.js still has older payment lines for some items, this shows what you stored.
        // Prefer updating catalog.js too later, but this page will still look fine.
        qs("#pDelivery").innerHTML = (P.delivery || []).map(([k,v]) => {
          // Normalize common payment copy for UI consistency
          const vv = (String(k).toLowerCase() === "payment")
            ? "Payment link after confirmation"
            : v;
          return `<div class="summary-row"><div class="summary-k">${escapeHtml(k)}</div><div class="summary-v">${escapeHtml(vv)}</div></div>`;
        }).join("");

        // WhatsApp
        wireWhatsAppButton();
      }
    </script>
  </main>
</body>
</html>
